<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ecoaldea Tanaj – Mapa con Datos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <!-- PapaParse (para CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
  </style>
</head>
<body>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // --- 1) Inicia el mapa ---
    const initialView = { center: [18.51, -89.88], zoom: 10 };
    const map = L.map('map').setView(initialView.center, initialView.zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Funciones de control de vista
    function resetView() {
      map.setView(initialView.center, initialView.zoom, { animate: true });
    }
    function zoomTo(latlng) {
      map.setView(latlng, 16, { animate: true });
    }

    // --- 2) Inyectar la leyenda externa ---
    fetch('legend.html')
      .then(res => res.text())
      .then(html => {
        const div = document.createElement('div');
        div.innerHTML = html;
        document.body.appendChild(div);
      })
      .catch(err => console.error('No se pudo cargar legend.html:', err));

    // --- 3) Carga y parseo del CSV ---
    let csvById = {};
    Papa.parse('data/Listado_de_Puntos.csv', {
      download: true,
      header: true,
      complete(results) {
        results.data.forEach(row => {
          // Aquí usamos row.id (minúscula), tal como está en tu CSV
          if (row.id !== undefined && row.id !== "") {
            csvById[String(row.id)] = row;
          }
        });
        loadGeoJSON();
      },
      error(err) {
        console.error('Error leyendo CSV:', err);
      }
    });

    // --- 4) Carga del GeoJSON y unión con CSV ---
    function loadGeoJSON() {
      fetch('data/puntos.geojson')
        .then(r => r.json())
        .then(geojson => {
          L.geoJSON(geojson, {
            pointToLayer(feature, latlng) {
              // Soporte para Id en mayúscula o minúscula
              const rawId = feature.properties.Id ?? feature.properties.id;
              const id = String(rawId);
              return L.marker(latlng, {
                icon: L.icon({
                  iconUrl: `iconos/punto_${id}.png`,
                  iconSize: [30,30],
                  iconAnchor: [15,30]
                })
              });
            },
            onEachFeature(feature, layer) {
              const props = feature.properties;
              const rawId = props.Id ?? props.id;
              const id = String(rawId);
              const row = csvById[id] || {};
              // Extraemos los campos
              const distancia = row["Distancia a Tanaj"] || 'N/D';
              const ubic = row["Ubicación"] 
                ? `<a href="${row["Ubicación"]}" target="_blank">Ver ubicación</a>` 
                : '';
              const info = row["Información relevante"]
                ? `<a href="${row["Información relevante"]}" target="_blank">Más info</a>` 
                : '';
              // Construimos el popup
              const html = `
                <h3>${props.Nombre || 'Sin nombre'}</h3>
                <p><strong>Distancia a Tanaj:</strong> ${distancia}</p>
                ${ubic ? `<p>${ubic}</p>` : ''}
                ${info ? `<p>${info}</p>` : ''}
              `;
              layer.bindPopup(html);
            }
          }).addTo(map);
        })
        .catch(err => console.error('No se pudo cargar puntos.geojson:', err));
    }
  </script>
</body>
</html>
